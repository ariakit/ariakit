---
import CodeBlockContent from "./code-block-content.astro";
import { CodeBlockTabs as CodeBlockTabsReact } from "./code-block.react.tsx";
import type { ComponentProps } from "astro/types";
import type { Source } from "../../plugins/source-plugin.ts";
import type { CodeBlockTabProps } from "./code-block.types";
import { getLangFromFilename } from "../lib/shiki.ts";
import * as icons from "../icons/icons.ts";

interface Props
  extends Omit<ComponentProps<typeof CodeBlockTabsReact>, "framework"> {
  source?: Source;
}

const {
  source,
  tabs: tabsFromProps,
  lineNumbers = true,
  maxLines = 17,
  ...props
} = Astro.props;

const { framework } = Astro.locals;

function hasIcon(name: string): name is keyof typeof icons {
  return name in icons;
}

function isTsxFramework(
  framework: string
): framework is "react" | "solid" | "preact" {
  return ["react", "solid", "preact"].includes(framework);
}

const tabsFromSource = source
  ? Object.entries(source.files).map(([filename, code]) => {
      const lang = getLangFromFilename(filename);
      const filenameIcon =
        lang === "tsx" && framework && isTsxFramework(framework)
          ? framework
          : hasIcon(lang)
            ? lang
            : undefined;
      return {
        code,
        filename,
        filenameIcon,
      } satisfies CodeBlockTabProps;
    })
  : [];

const tabs = tabsFromProps || tabsFromSource;
---

<CodeBlockTabsReact client:visible {framework} {tabs} {maxLines} {...props}>
  {tabs[0] && <CodeBlockContent slot="slot0" {lineNumbers} {...tabs[0]} />}
  {tabs[1] && <CodeBlockContent slot="slot1" {lineNumbers} {...tabs[1]} />}
  {tabs[2] && <CodeBlockContent slot="slot2" {lineNumbers} {...tabs[2]} />}
  {tabs[3] && <CodeBlockContent slot="slot3" {lineNumbers} {...tabs[3]} />}
  {tabs[4] && <CodeBlockContent slot="slot4" {lineNumbers} {...tabs[4]} />}
  {tabs[5] && <CodeBlockContent slot="slot5" {lineNumbers} {...tabs[5]} />}
  {tabs[6] && <CodeBlockContent slot="slot6" {lineNumbers} {...tabs[6]} />}
  {tabs[7] && <CodeBlockContent slot="slot7" {lineNumbers} {...tabs[7]} />}
</CodeBlockTabsReact>
