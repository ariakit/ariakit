name: deploy-preview

on:
  workflow_run:
    workflows: ["app"]
    types: [completed]

jobs:
  deploy:
    name: Deploy preview
    runs-on: ubuntu-latest
    environment: Preview
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
    permissions:
      actions: read
      contents: read
      deployments: write
      statuses: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check repository
        id: check-repo
        env:
          HEAD_REPO: ${{ github.event.workflow_run.head_repository.full_name }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          if [ "$HEAD_REPO" = "$REPO" ]; then
            echo "same_repo=true" >> "$GITHUB_OUTPUT"
          else
            echo "same_repo=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set commit status (pending)
        uses: actions/github-script@v8
        env:
          SERVER_URL: ${{ github.server_url }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          SAME_REPO: ${{ steps.check-repo.outputs.same_repo }}
        with:
          script: |
            const { SERVER_URL, REPO, RUN_ID, HEAD_SHA, SAME_REPO } = process.env;
            const runUrl = `${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}`;
            const args = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: HEAD_SHA,
              state: 'pending',
              target_url: runUrl,
            };
            await github.rest.repos.createCommitStatus({ ...args, context: 'Preview (commit)' });
            if (SAME_REPO === 'true') {
              await github.rest.repos.createCommitStatus({ ...args, context: 'Preview (branch)' });
            }

      - name: Generate preview alias
        id: alias
        if: steps.check-repo.outputs.same_repo == 'true' && github.event.workflow_run.head_branch != 'main'
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          SAFE=$(printf "%s" "$HEAD_BRANCH" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9-]+#-#g' | sed -E 's#^-+##; s#-+$##')
          echo "slug=$SAFE" >> "$GITHUB_OUTPUT"

      - name: Install node modules
        uses: ./.github/workflows/install-node-modules

      - name: Download Next.js app artifact
        id: download-nextjs-artifact
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: nextjs-dist
          path: nextjs/.open-next
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download app artifact
        id: download-app-artifact
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: app-dist
          path: site/dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Next.js app version
        id: versions-nextjs
        if: steps.download-nextjs-artifact.outcome == 'success'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          workingDirectory: nextjs
          command: >-
            versions upload
            ${{ steps.alias.outputs.slug && format('--preview-alias {0}', steps.alias.outputs.slug) }}

      - name: Upload app version
        id: versions
        if: steps.download-app-artifact.outcome == 'success'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          command: >-
            versions upload --env preview
            ${{ steps.alias.outputs.slug && format('--preview-alias {0}', steps.alias.outputs.slug) }}

      - name: Deploy Next.js app version
        if: steps.download-nextjs-artifact.outcome == 'success' && steps.check-repo.outputs.same_repo == 'true' && github.event.workflow_run.head_branch == 'main'
        id: deploy-nextjs
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          workingDirectory: nextjs
          command: deploy

      - name: Deploy app version
        if: steps.download-app-artifact.outcome == 'success' && steps.check-repo.outputs.same_repo == 'true' && github.event.workflow_run.head_branch == 'main'
        id: deploy
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          command: deploy --env preview

      - name: Set commit status (result)
        if: always()
        uses: actions/github-script@v8
        env:
          SERVER_URL: ${{ github.server_url }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          SAME_REPO: ${{ steps.check-repo.outputs.same_repo }}
          VERSIONS_SUCCESS: ${{ steps.versions.outcome == 'success' && steps.versions-nextjs.outcome == 'success' }}
          DEPLOY_SUCCESS: ${{ steps.deploy.outcome == 'success' && steps.deploy-nextjs.outcome == 'success' }}
          DEPLOY_URL: ${{ steps.deploy.outputs.deployment-url }}
          VERSION_URL: ${{ steps.versions.outputs.deployment-url }}
          ALIAS_URL: ${{ steps.alias.outputs.slug }}
        with:
          script: |
            const { SERVER_URL, REPO, RUN_ID, HEAD_SHA, SAME_REPO, VERSIONS_SUCCESS, DEPLOY_SUCCESS, DEPLOY_URL, VERSION_URL, ALIAS_URL } = process.env;
            const versionsSuccess = VERSIONS_SUCCESS === 'true';
            const deploySuccess = DEPLOY_SUCCESS === 'true';
            const runUrl = `${SERVER_URL}/${REPO}/actions/runs/${RUN_ID}`;
            const deployUrl = DEPLOY_URL;
            const versionUrl = VERSION_URL;
            const aliasUrl = ALIAS_URL && versionUrl
              ? versionUrl.replace(/^(https?:\/\/)[^-]+/, `$1${ALIAS_URL}`)
              : '';
            const commitTarget = versionsSuccess && versionUrl
              ? versionUrl
              : '';
            const branchTarget = versionsSuccess && aliasUrl
              ? aliasUrl
              : deploySuccess && deployUrl ? deployUrl : '';
            const args = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: HEAD_SHA,
            };
            await github.rest.repos.createCommitStatus({
              ...args,
              state: commitTarget ? 'success' : 'failure',
              target_url: commitTarget || runUrl,
              context: 'Preview (commit)',
            });
            if (SAME_REPO === 'true') {
              await github.rest.repos.createCommitStatus({
                ...args,
                state: branchTarget ? 'success' : 'failure',
                target_url: branchTarget || runUrl,
                context: 'Preview (branch)',
              });
            }
