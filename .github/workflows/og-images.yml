name: og-images

on:
  workflow_run:
    workflows: ["app"]
    types: [completed]

concurrency:
  group: og-images-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  gate:
    name: Ignore stale commits
    if: github.event.workflow_run.conclusion == 'failure'
    uses: ./.github/workflows/ignore-stale-commits.yml
    with:
      head_repository: ${{ github.event.workflow_run.head_repository.full_name }}
      head_branch: ${{ github.event.workflow_run.head_branch }}
      head_sha: ${{ github.event.workflow_run.head_sha }}

  generate:
    name: Generate OG images
    needs: gate
    if: needs.gate.outputs.is_latest == 'true'
    runs-on: macos-latest
    permissions:
      actions: read
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.ARIAKIT_BOT_PAT }}
          persist-credentials: true

      - name: Download app artifact
        uses: actions/download-artifact@v5
        with:
          name: app-dist
          path: site/dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install node modules
        uses: ./.github/workflows/install-node-modules

      - name: Install Playwright
        uses: ./.github/workflows/install-playwright
        with:
          engine: chromium

      - name: Generate OG images
        run: npm run og-image-generate -w site

      - name: Commit or create PR
        uses: ./.github/workflows/commit-or-pr
        with:
          event: ${{ github.event.workflow_run.event }}
          message: Update OG images
          head-branch: ${{ github.event.workflow_run.head_branch }}
          new-branch: chore/update-og-images
