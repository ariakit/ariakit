name: release-preview

on:
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

      - name: Install node modules
        uses: ./.github/workflows/install-node-modules
        with:
          cache-npm: true

      - name: Build
        run: npm run build

      - name: Get changeset status
        id: changeset-status
        run: |
          # Only consider changesets added since the base branch (i.e., in this PR)
          if npx changeset status --since=${{ github.base_ref }} --output changes.json 2>/dev/null; then
            echo "has-changesets=true" >> $GITHUB_OUTPUT
          else
            echo "has-changesets=false" >> $GITHUB_OUTPUT
          fi

      - name: Compute affected packages
        id: compute-affected-packages
        if: steps.changeset-status.outputs.has-changesets == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('node:fs');
            const path = require('node:path');
            const changes = JSON.parse(fs.readFileSync('changes.json', 'utf8'));
            const packageDirs = fs.readdirSync('packages', { withFileTypes: true })
              .filter(d => d.isDirectory())
              .map(d => path.join('packages', d.name));
            const packagesMap = Object.fromEntries(packageDirs.map(dir => {
              const pkg = JSON.parse(fs.readFileSync(path.join(dir, 'package.json'), 'utf8'));
              return [pkg.name, dir];
            }));
            const affectedPackages = changes.releases.map(r => packagesMap[r.name]).filter(Boolean);
            core.setOutput('affected-packages', JSON.stringify(affectedPackages));

      - name: Publish preview
        if: steps.changeset-status.outputs.has-changesets == 'true'
        env:
          AFFECTED_PACKAGES: ${{ steps.compute-affected-packages.outputs.affected-packages }}
        run: |
          packages=$(echo $AFFECTED_PACKAGES | jq -r '.[]' | tr '\n' ' ')
          if [ -n "$packages" ]; then
            npx pkg-pr-new publish --compact --template './templates/*' $packages
          else
            echo "No affected packages to publish"
          fi
