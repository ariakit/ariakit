name: commit-or-pr
description: Commit or create a pull request

inputs:
  event:
    description: Event type (push or pull_request)
    required: true
  message:
    description: Commit message and PR title
    required: true
  head-branch:
    description: Branch name when committing to existing PR
    required: true
  new-branch:
    description: Branch name when creating a new PR
    required: true
  token:
    description: Token used for PR creation (defaults to GITHUB_TOKEN)
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Configure git
      shell: bash
      run: |
        git config user.name "ariakit-bot"
        git config user.email "ariakit-bot@users.noreply.github.com"

    - name: Create PR
      if: inputs.event == 'push'
      uses: peter-evans/create-pull-request@v7
      with:
        commit-message: ${{ inputs.message }}
        title: ${{ inputs.message }}
        base: ${{ inputs.head-branch }}
        branch: ${{ inputs.new-branch }}
        delete-branch: true
        token: ${{ inputs.token != '' && inputs.token || github.token }}
        author: ariakit-bot <ariakit-bot@users.noreply.github.com>
        committer: ariakit-bot <ariakit-bot@users.noreply.github.com>

    - name: Commit changes
      id: commit
      shell: bash
      if: inputs.event == 'pull_request'
      env:
        MESSAGE: ${{ inputs.message }}
      run: |
        git add -A
        if git diff --cached --quiet --exit-code; then
          echo "No files to commit."
          echo "did_commit=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        git commit -m "$MESSAGE"
        echo "did_commit=true" >> "$GITHUB_OUTPUT"

    - name: Push to PR head branch
      shell: bash
      if: ${{ inputs.event == 'pull_request' && steps.commit.outputs.did_commit == 'true' }}
      env:
        HEAD_REF: ${{ inputs.head-branch }}
        PUSH_TOKEN: ${{ inputs.token != '' && inputs.token || github.token }}
      run: |
        set +e
        token_header=$(printf "x-access-token:%s" "$PUSH_TOKEN" | base64 | tr -d '\n')
        git -c http.https://github.com/.extraheader="AUTHORIZATION: basic $token_header" fetch origin "$HEAD_REF"
        git rebase "origin/$HEAD_REF" || true
        git -c http.https://github.com/.extraheader="AUTHORIZATION: basic $token_header" push origin HEAD:"${HEAD_REF}"
        status=$?
        if [ $status -ne 0 ]; then
          echo "Failed to push to PR head."
          exit 1
        fi
