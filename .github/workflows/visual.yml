name: visual

on:
  workflow_run:
    workflows: ["app"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  gate:
    name: Ignore stale commits
    permissions:
      contents: read
    if: github.event.workflow_run.conclusion == 'failure'
    uses: ./.github/workflows/ignore-stale-commits.yml
    with:
      head_repository: ${{ github.event.workflow_run.head_repository.full_name }}
      head_branch: ${{ github.event.workflow_run.head_branch }}
      head_sha: ${{ github.event.workflow_run.head_sha }}

  update-snapshots:
    name: Update snapshots
    needs: gate
    if: needs.gate.outputs.is_latest == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.ARIAKIT_BOT_PAT }}
          persist-credentials: false

      - name: Prepare visual directory
        run: |
          rm -rf site/src/tests/visual
          mkdir -p site/src/tests/visual

      - name: Download snapshots
        uses: actions/download-artifact@v5
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pattern: app-visual-*
          merge-multiple: true
          path: site/src/tests/visual

      - name: Commit or create PR
        uses: ./.github/workflows/commit-or-pr
        with:
          event: ${{ github.event.workflow_run.event }}
          message: Update snapshots
          head-branch: ${{ github.event.workflow_run.head_branch }}
          new-branch: visual/update-snapshots
          token: ${{ secrets.ARIAKIT_BOT_PAT }}
