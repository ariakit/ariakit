name: visual

on:
  workflow_run:
    workflows: ["app"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  gate:
    name: Ignore stale commits
    permissions:
      contents: read
    if: github.event.workflow_run.conclusion == 'failure'
    uses: ./.github/workflows/ignore-stale-commits.yml
    with:
      head_repository: ${{ github.event.workflow_run.head_repository.full_name }}
      head_branch: ${{ github.event.workflow_run.head_branch }}
      head_sha: ${{ github.event.workflow_run.head_sha }}

  update-snapshots:
    name: Update snapshots
    needs: gate
    if: needs.gate.outputs.is_latest == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write
      pull-requests: write
    steps:
      - name: Check for snapshot artifacts
        id: check-artifacts
        uses: actions/github-script@v8
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            const hasSnapshots = artifacts.data.artifacts.some(a => a.name.startsWith('app-visual-'));
            console.log(`Found ${artifacts.data.artifacts.length} artifacts, hasSnapshots: ${hasSnapshots}`);
            return hasSnapshots;
          result-encoding: string

      - name: Checkout repository
        if: steps.check-artifacts.outputs.result == 'true'
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.ARIAKIT_BOT_PAT }}
          persist-credentials: false

      - name: Prepare visual directory
        if: steps.check-artifacts.outputs.result == 'true'
        run: |
          rm -rf site/src/tests/visual
          mkdir -p site/src/tests/visual

      - name: Download snapshots
        if: steps.check-artifacts.outputs.result == 'true'
        uses: actions/download-artifact@v7
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pattern: app-visual-*
          merge-multiple: true
          path: site/src/tests/visual

      - name: Commit or create PR
        uses: ./.github/workflows/commit-or-pr
        with:
          event: ${{ github.event.workflow_run.event }}
          message: Update snapshots
          head-branch: ${{ github.event.workflow_run.head_branch }}
          new-branch: visual/update-snapshots
          token: ${{ secrets.ARIAKIT_BOT_PAT }}
