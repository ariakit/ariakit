name: ignore-stale-commits

on:
  workflow_call:
    inputs:
      head_repository:
        description: The head repository full name (owner/repo)
        required: true
        type: string
      head_branch:
        description: The head branch name
        required: true
        type: string
      head_sha:
        description: The head SHA from the triggering workflow_run
        required: true
        type: string
    outputs:
      is_latest:
        description: Whether the triggering run is the latest commit on the branch
        value: ${{ jobs.gate.outputs.is_latest }}

jobs:
  gate:
    name: Ignore stale commits
    runs-on: ubuntu-latest
    outputs:
      is_latest: ${{ steps.check.outputs.is_latest }}
    steps:
      - name: Read tip SHA on the branch
        id: tip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_REPO: ${{ inputs.head_repository }}
          HEAD_BRANCH: ${{ inputs.head_branch }}
        run: |
          set -euo pipefail
          # Get current tip commit of the branch in the head repo
          tip_sha=$(gh api repos/$HEAD_REPO/commits/$HEAD_BRANCH --jq .sha)
          echo "tip_sha=$tip_sha" >> "$GITHUB_OUTPUT"

      - name: Compare with triggering run SHA
        id: check
        env:
          HEAD_SHA: ${{ inputs.head_sha }}
          TIP_SHA: ${{ steps.tip.outputs.tip_sha }}
        run: |
          if [ "$HEAD_SHA" = "$TIP_SHA" ]; then
            echo "is_latest=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_latest=false" >> "$GITHUB_OUTPUT"
          fi
